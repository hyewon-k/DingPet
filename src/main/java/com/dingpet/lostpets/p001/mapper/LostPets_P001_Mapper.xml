<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.or//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- LOST -->
<mapper
	namespace="com.dingpet.lostpets.p001.mapper.LostPets_P001_Mapper">

	<!-- 페이지 처리한 목록 조회 -->
	<select id = "listWithPaging" resultMap = "listWithPagingMap">
		<![CDATA[
			SELECT board_id, title, dog_breed, dog_sex, found_location
			FROM 
			(
				SELECT /*+INDEX_DESC (LOST_FOUND LOST_FOUND_IX)*/ rownum rn, board_id, title, dog_breed, dog_sex, found_location
				FROM lost_found LF, dog D
				WHERE LF.dog_id = D.dog_id
				AND status = 'n'
				AND rownum <= #{pageNum} * #{amount}
				AND board_id > 0
			)
			where rn > (#{pageNum} - 1) * #{amount}
			ORDER BY board_id DESC
		]]> 
	</select>
	<resultMap id = "listWithPagingMap" type = "java.util.HashMap">
		<result column = "board_id" property = "board_id"/>
		<result column = "title" property = "title"/>
		<result column = "dog_breed" property = "dog_breed"/>
		<result column = "dog_sex" property = "dog_sex"/>
		<result column = "found_location" property = "found_location"/>
	</resultMap>
	<!-- 전체 글 수 가져오는 query -->
	<select id = "getTotalAmount" resultType = "int">
		SELECT count(*)
		FROM lost_found
		WHERE board_id > 0
	</select>
	<!-- 글 목록 끝 -->
	
	<!-- 유기견 글 목록  -->
	<select id = "getLost" resultType="com.dingpet.lostpets.p001.vo.LostPets_P001_VO">
	<![CDATA[
		SELECT board_id, member_id, title, dog_breed, dog_sex, found_location, front_name
		FROM (
			SELECT rownum rn, LF.board_id, LF.member_id, LF.title, D.dog_breed, D.dog_sex, D.found_location, P.front_name 
		    FROM lost_found LF, dog D, lost_found_photo P
	        WHERE LF.dog_id = D.dog_id
	        AND LF.board_id = P.board_id
	        AND LF.category = 'lost'
	        AND LF.status = 'n'
	        AND rownum <= #{pageNum} * #{amount}
			AND LF.board_id > 0
		)
		WHERE rn > (#{pageNum} - 1) * #{amount}
        ORDER BY board_id DESC
        ]]> 
	</select>
	<!-- 유기견 전체 글 수 -->
	<select id = "getLostAmount" resultType = "int">
		SELECT count(*)
		FROM lost_found
		WHERE category = 'lost'
		AND status = 'n'
		AND board_id > 0
	</select>
	
	<!-- 실종견  글 목록  -->
	<select id = "getFind" resultType="com.dingpet.lostpets.p001.vo.LostPets_P001_VO">
		<![CDATA[
		SELECT board_id, member_id, title, dog_breed, dog_sex, found_location, front_name
		FROM (
			SELECT rownum rn, LF.board_id, LF.member_id, LF.title, D.dog_breed, D.dog_sex, D.found_location, P.front_name 
		    FROM lost_found LF, dog D, lost_found_photo P
	        WHERE LF.dog_id = D.dog_id
	        AND LF.board_id = P.board_id
	        AND LF.category = 'find'
	        AND LF.status = 'n'
	        AND rownum <= #{pageNum} * #{amount}
			AND LF.board_id > 0
		)
		WHERE rn > (#{pageNum} - 1) * #{amount}
        ORDER BY board_id DESC
        ]]> 
	</select>
	<!-- 실종견 전체 글 수 -->
	<select id = "getFindAmount" resultType = "int">
		SELECT count(*)
		FROM lost_found
		WHERE category = 'find'
		AND status = 'n'
		AND board_id > 0
	</select>
	
	<!-- 완료 글 목록  -->
	<select id = "getCompleted" resultType="com.dingpet.lostpets.p001.vo.LostPets_P001_VO">
	
	</select>
	<!-- 유기견 전체 글 수 -->
	<select id = "getCompletedAmount" resultType = "int">
		
	</select>
	

	<!-- 글 등록 --> 
	<select id = "getDogId" resultType = "string">
		SELECT seq_dog.nextval
		FROM dual
	</select>
	
	<select id = "getBoardId" resultType = "string">
		SELECT seq_lost_found.nextval
		FROM dual
	</select>
	
	<insert id="writeLost" parameterType="java.util.Map">
		insert into lost_found
		(category, board_id, member_id, dog_id, title, content, 
		board_date, status, status_reason)
		values (#{category}, #{board_id}, #{member_id}, #{dog_id}, #{title}, #{content},
		to_char(sysdate, 'yyyymmddhh24mi'), 'n', null)
	</insert>

	<insert id = "writeDog" parameterType = "java.util.Map">
		 insert into dog (dog_id, dog_type, member_id, dog_name, dog_breed, dog_sex, dog_size, 
		 dog_note, found_date, found_location)
		values (#{dog_id}, 'stray', #{member_id}, #{dog_name}, #{dog_breed}, #{dog_sex}, #{dog_size},
		#{dog_note}, #{found_date}, #{found_location})
	</insert>
	
	<insert id = "upload" parameterType = "java.util.Map">
		INSERT INTO lost_found_photo (
			board_id, category, front_name, front_path)
		VALUES (#{board_id}, #{category}, #{front_name}, #{front_path})
	</insert>
	<!-- 글 등록 끝 -->



	<!-- 글 조회 -->
	<select id="view" resultType="com.dingpet.lostpets.p001.vo.LostPets_P001_VO" parameterType = "String">
		select LF.category, LF.board_id, LF.member_id, LF.dog_id, title, content, board_date, 
			dog_name, dog_breed, dog_sex, dog_size, dog_note, found_date, found_location, 
			front_name, front_path
		from lost_found LF, dog D, lost_found_photo P 
		where LF.dog_id = D.dog_id
		and LF.board_id = P.board_id
		and LF.board_id = #{board_id}
	</select>
	<!-- 글 조회 끝 -->



	<!-- 글 수정 : 게시판 분류, 제목, 내용, 완료여부, 완료사유, 사진1,2,3 -->
	<update id="modifyLost"  parameterType="com.dingpet.lostpets.p001.vo.LostPets_P001_VO" >
		UPDATE lost_found
		SET
			category = #{category,  jdbcType=VARCHAR},
			title = #{title,  jdbcType=VARCHAR},
			content = #{content,  jdbcType=VARCHAR},
			status = #{status, jdbcType=CHAR},
			status_reason = #{status_reason, jdbcType=VARCHAR}
		where (board_id=#{board_id,  jdbcType=VARCHAR})
	</update>
	<update id="modifyDog" parameterType="com.dingpet.lostpets.p001.vo.LostPets_P001_VO" >
		UPDATE dog
		SET
			dog_name = #{dog_name, jdbcType = VARCHAR},
			dog_breed = #{dog_breed, jdbcType = VARCHAR},
			dog_sex = #{dog_sex, jdbcType = VARCHAR},
			dog_size = #{dog_size, jdbcType = VARCHAR},
			dog_note = #{dog_note, jdbcType = VARCHAR},
			found_date = #{found_date, jdbcType = VARCHAR},
			found_location = #{found_location, jdbcType = VARCHAR}
		WHERE dog_id = #{dog_id, jdbcType=VARCHAR}
	</update>

	<!-- 글 삭제 -->
	<delete id="deleteLost">
		delete from lost_found 
		where board_id = #{board_id}
	</delete>
	
	<delete id="deleteDog">
		delete from Dog 
		where dog_id = #{dog_id}
	</delete>
	
	<delete id="deletePhoto">
		delete from lost_found_photo
		where board_id = #{board_id}
	</delete>
	<!-- 글 삭제 끝 -->


	

</mapper>